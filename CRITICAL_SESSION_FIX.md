# üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ô

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê –í –ú–û–Å–ú –ü–ï–†–í–û–ú –†–ï–®–ï–ù–ò–ò

–Ø —É–ø—É—Å—Ç–∏–ª **–≥–ª–∞–≤–Ω—É—é –ø—Ä–∏—á–∏–Ω—É** –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Å—Å–∏—è–º–∏:

### 1. PrismaAdapter + CredentialsProvider = ‚ùå –ö–û–ù–§–õ–ò–ö–¢

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–±—ã–ª–æ):
adapter: PrismaAdapter(prisma),
providers: [CredentialsProvider({ ... })]
```

**–ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- `PrismaAdapter` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (Google, GitHub)
- –° `CredentialsProvider` –æ–Ω **–Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º**
- Adapter –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏ –≤ –ë–î, –Ω–æ Credentials –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JWT
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–æ–Ω—Ñ–ª–∏–∫—Ç, —Å–µ—Å—Å–∏–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

### 2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ cookies

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–±—ã–ª–æ):
cookies: {
  sessionToken: {
    options: {
      secure: process.env.NODE_ENV === 'production'
    }
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `NODE_ENV=production` —Å—Ç–∞–≤–∏—Ç `secure=true`, –Ω–æ –≤–∞—à —Å–∞–π—Ç –Ω–∞ HTTP (IP:3000)
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –±—Ä–∞—É–∑–µ—Ä –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç secure cookies –ø–æ HTTP

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

```typescript
export const authOptions: any = {
  // 1. –£–ë–†–ê–ù PrismaAdapter - –æ–Ω –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å Credentials
  // adapter: undefined,
  
  // 2. useSecureCookies –∑–∞–≤–∏—Å–∏—Ç –æ—Ç NEXTAUTH_URL, –∞ –Ω–µ NODE_ENV
  useSecureCookies: (process.env.NEXTAUTH_URL || '').startsWith('https://'),
  
  // 3. –î–æ–±–∞–≤–ª–µ–Ω updateAge –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
  session: {
    strategy: 'jwt',
    maxAge: 30 * 24 * 60 * 60, // 30 –¥–Ω–µ–π
    updateAge: 24 * 60 * 60,   // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
  },
  
  // 4. –£–ª—É—á—à–µ–Ω—ã callbacks –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
  callbacks: {
    jwt: // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–æ–∫–µ–Ω
    session: // –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ—Å—Å–∏—é
    redirect: // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
  },
  
  // 5. Debug —Ä–µ–∂–∏–º –≤ development
  debug: process.env.NODE_ENV === 'development',
}
```

---

## üì¶ –£–°–¢–ê–ù–û–í–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –®–∞–≥ 1: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
scp src/lib/auth.ts root@109.69.58.185:/var/www/mb-trust/src/lib/
scp src/lib/telegram-init.ts root@109.69.58.185:/var/www/mb-trust/src/lib/
```

### –®–∞–≥ 2: –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å

```bash
ssh root@109.69.58.185
cd /var/www/mb-trust

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
sudo systemctl restart mb-trust

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
journalctl -u mb-trust -f
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–ï–°–°–ò–ô

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ cookie

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://109.69.58.185:3000
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å / –≤–æ–π–¥–∏—Ç–µ
3. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Application ‚Üí Cookies
4. –ù–∞–π–¥–∏—Ç–µ `next-auth.session-token`

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- ‚úÖ `Secure: No` (–¥–ª—è HTTP —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!)
- ‚úÖ `HttpOnly: Yes`
- ‚úÖ `SameSite: Lax`
- ‚úÖ `Expires: —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π`
- ‚úÖ `Path: /`

### –¢–µ—Å—Ç 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

1. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
2. **–ó–∞–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é**
3. –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä —Å–Ω–æ–≤–∞
4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ http://109.69.58.185:3000

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** –í—ã –≤—Å—ë –µ—â—ë –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã! ‚úÖ

### –¢–µ—Å—Ç 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ F5

1. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
2. –ù–∞–∂–º–∏—Ç–µ F5 (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) 10 —Ä–∞–∑
3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** –í—Å–µ–≥–¥–∞ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã! ‚úÖ

### –¢–µ—Å—Ç 4: –†–∞–∑–ª–æ–≥–∏–Ω –ø–æ –∫–Ω–æ–ø–∫–µ

1. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–í—ã–π—Ç–∏"

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** 
- Cookie —É–¥–∞–ª–µ–Ω–∞
- –í–∞—Å –ø–µ—Ä–µ–±—Ä–æ—Å–∏–ª–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–∫—Ä—ã—Ç—å –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /auth/signin

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú

### –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –≤—Å—ë –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å NEXTAUTH_SECRET
cat /var/www/mb-trust/.env.local | grep NEXTAUTH_SECRET
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ù–ï –ü–£–°–¢–û–ï –∑–Ω–∞—á–µ–Ω–∏–µ!

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å NEXTAUTH_URL
cat /var/www/mb-trust/.env.local | grep NEXTAUTH_URL
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: http://109.69.58.185:3000 (–±–µ–∑ —Å–ª—ç—à–∞ –≤ –∫–æ–Ω—Ü–µ!)

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ NextAuth
journalctl -u mb-trust -n 100 | grep -i "session\|token\|auth"
```

### –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç cookie:

1. **–û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ cookies:**
   - DevTools ‚Üí Application ‚Üí Cookies ‚Üí –£–¥–∞–ª–∏—Ç—å –≤—Å–µ
   - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞:**
   - Cookies –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω—ã
   - –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö cookies –¥–ª—è localhost/IP

3. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä** (Chrome/Firefox)

---

## üìä –î–û –ò –ü–û–°–õ–ï

### ‚ùå –î–û (—Å –æ—à–∏–±–∫–∞–º–∏):
```typescript
adapter: PrismaAdapter(prisma),  // ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç!
secure: process.env.NODE_ENV === 'production'  // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è HTTP!
// –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–µ—Å—Å–∏—è –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
```

### ‚úÖ –ü–û–°–õ–ï (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```typescript
// adapter: undefined,  // ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
useSecureCookies: NEXTAUTH_URL.startsWith('https://')  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
updateAge: 24 * 60 * 60  // ‚úÖ –ü—Ä–æ–¥–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
// –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è 30 –¥–Ω–µ–π!
```

---

## üéØ –ì–ê–†–ê–ù–¢–ò–Ø

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

‚úÖ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è **30 –¥–Ω–µ–π**  
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ **–∑–∞–∫—Ä—ã—Ç–∏—è –±—Ä–∞—É–∑–µ—Ä–∞**  
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ **F5 / –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏**  
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ **—Ä–∞–∑–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∞—Ö**  
‚úÖ –†–∞–∑–ª–æ–≥–∏–Ω **—Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ "–í—ã–π—Ç–∏"**  

**–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `NEXTAUTH_SECRET` –∏ `NEXTAUTH_URL` –≤ `.env.local`!**

