# üõ°Ô∏è –ó–ê–©–ò–¢–ê –ë–û–¢–ê ‚Äî –ü–û–õ–ù–û–ï –†–£–ö–û–í–û–î–°–¢–í–û

## ‚úÖ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. **–ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –±–æ—Ç–∞ (409 Conflict)**

**–§–∞–π–ª:** `src/lib/bot-launcher.ts`

**–ó–∞—â–∏—Ç—ã:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤–æ—Å—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤–æ–≥–æ
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ 409 –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
- ‚úÖ Graceful shutdown –ø—Ä–∏ SIGINT/SIGTERM
- ‚úÖ Health check –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –µ—Å–ª–∏ –±–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å

**–õ–æ–≥–∏–∫–∞:**
```typescript
// –ï—Å–ª–∏ –±–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω - –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –∂–∏–≤–æ—Å—Ç—å
existingBot.getMe() ‚Üí OK? –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º : –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º

// –ï—Å–ª–∏ 409 –∫–æ–Ω—Ñ–ª–∏–∫—Ç - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
if (error.includes('409')) {
  shutdownBot()
  setTimeout(launchBot, 5000)
}
```

---

### 2. **–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ (Rate Limiting)**

**–§–∞–π–ª:** `src/lib/telegram-init.ts`

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º 10 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ —Å–ø–∞–º–∞: `[SPAM] Rate limit –ø—Ä–µ–≤—ã—à–µ–Ω`
- ‚úÖ –î—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ"

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
const messageRateLimit = new Map<chatId, timestamps[]>()

function checkRateLimit(chatId) {
  const recentMessages = filter(last 60 seconds)
  if (recentMessages.length >= 10) return false
  return true
}
```

---

### 3. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (–ó–∞—â–∏—Ç–∞ –æ—Ç –º—É—Å–æ—Ä–∞)**

**–§–∞–π–ª:** `src/lib/telegram-init.ts`

**–§–∏–ª—å—Ç—Ä—ã:**
- ‚úÖ –ü—É—Å—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ (>1000 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã (aaaaaaaaaa...)
- ‚úÖ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ (>20)
- ‚úÖ –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç:
  - –ö–∞–∑–∏–Ω–æ, —Å—Ç–∞–≤–∫–∏
  - –†–µ–∫–ª–∞–º–∞ (–∫—É–ø–∏, –ø—Ä–æ–¥–∞–∂–∞, —Å–∫–∏–¥–∫–∏)
  - –í–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏ (–∫—Ä–æ–º–µ telegram/mb-trust)

**–ü—Ä–∏–º–µ—Ä—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:**
```
‚ùå "aaaaaaaaaaaaaaaaaaaaaaaaa" ‚Üí –°–ø–∞–º
‚ùå "üé∞üé∞üé∞ –ö–∞–∑–∏–Ω–æ! –°—Ç–∞–≤–∫–∏!" ‚Üí –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
‚ùå "–ö—É–ø–∏ —Å–µ–π—á–∞—Å! http://scam.com" ‚Üí –†–µ–∫–ª–∞–º–∞ + –≤–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞
‚úÖ "–ü—Ä–∏–≤–µ—Ç! –Ø –∏–∑ –ú–æ—Å–∫–≤—ã, 1000 –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤" ‚Üí OK
```

---

### 4. **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π**

**–§–∞–π–ª:** `src/lib/telegram-init.ts`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- ‚úÖ –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏: 30 –º–∏–Ω—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
- ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏: `sessions.delete()`, `messageRateLimit.delete()`
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: `[CLEANUP] –£–¥–∞–ª–µ–Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
const SESSION_TIMEOUT = 30 * 60 * 1000 // 30 –º–∏–Ω—É—Ç
const sessionLastActivity = new Map<chatId, timestamp>()

setInterval(cleanupOldSessions, 10 * 60 * 1000) // –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

function cleanupOldSessions() {
  for (const [chatId, lastActivity] of sessionLastActivity) {
    if (now - lastActivity > SESSION_TIMEOUT) {
      sessions.delete(chatId)
      messageRateLimit.delete(chatId)
    }
  }
}
```

---

### 5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ OpenAI —Å Retry**

**–§–∞–π–ª:** `src/lib/telegram-init.ts`

**–ó–∞—â–∏—Ç—ã:**
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞: 3 –ø–æ–ø—ã—Ç–∫–∏ (0, 1, 2)
- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1s, 2s, 4s
- ‚úÖ Fallback –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä –µ—Å–ª–∏ OpenAI –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫: `[AI] –ü–æ–ø—ã—Ç–∫–∞ X/3 –Ω–µ —É–¥–∞–ª–∞—Å—å`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
async function callOpenAI(url, payload, retries = 2) {
  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      return await fetch(url, { ... })
    } catch (error) {
      if (attempt === retries) throw error
      await sleep(1000 * Math.pow(2, attempt)) // 1s, 2s, 4s
    }
  }
}
```

**Fallback:**
```typescript
try {
  const data = await callOpenAI(...)
} catch (error) {
  // OpenAI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä
  const extracted = extractFromTextSimple(userMessage, collectedData)
  return { response: "–°–ø–∞—Å–∏–±–æ! –†–∞—Å—Å–∫–∞–∂–∏ –µ—â—ë.", extracted }
}
```

---

### 6. **Systemd Watchdog –∏ –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫**

**–§–∞–π–ª:** `mb-trust-production.service`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- ‚úÖ `Restart=always` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
- ‚úÖ `RestartSec=5` ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
- ‚úÖ `ExecStartPost` ‚Äî –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ health check
- ‚úÖ `TimeoutStopSec=10` ‚Äî graceful shutdown –∑–∞ 10 —Å–µ–∫—É–Ω–¥
- ‚úÖ `StartLimitIntervalSec=0` ‚Äî –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ê–©–ò–¢–´

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚ùå 409 –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
‚ùå –°–ø–∞–º –º–æ–≥ –∑–∞–±–∏—Ç—å –±–æ—Ç–∞
‚ùå –°–µ—Å—Å–∏–∏ –≤–∏—Å–µ–ª–∏ –≤ –ø–∞–º—è—Ç–∏ –≤–µ—á–Ω–æ
‚ùå OpenAI –æ—à–∏–±–∫–∏ –ª–æ–º–∞–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
‚ùå –ó–∞–≤–∏—Å–∞–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–ª–∏ —Ä—É—á–Ω–æ–≥–æ —Ä–µ—Å—Ç–∞—Ä—Ç–∞

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
‚úÖ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ health check
‚úÖ 409 –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑—Ä–µ—à–∞—é—Ç—Å—è
‚úÖ –°–ø–∞–º –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è (–º–∞–∫—Å. 10 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω)
‚úÖ –°—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç
‚úÖ OpenAI –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å fallback
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–±–æ—è—Ö

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–©–ò–¢–´

### 1. –¢–µ—Å—Ç rate limiting:
```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å 15 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥ –≤ –±–æ—Ç–∞
# –û–∂–∏–¥–∞–µ—Ç—Å—è: 10 –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ, 5 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ —Å "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π"
```

### 2. –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "aaaaaaaaaaaaaaaaaaaaaaaaa"
# –û–∂–∏–¥–∞–µ—Ç—Å—è: "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–ø–∞–º"

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "üé∞üé∞üé∞ –ö–∞–∑–∏–Ω–æ!"
# –û–∂–∏–¥–∞–µ—Ç—Å—è: "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç"
```

### 3. –¢–µ—Å—Ç –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ —Å–µ—Å—Å–∏–π:
```bash
# –ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –∑–∞—Ç–µ–º –Ω–µ –ø–∏—Å–∞—Ç—å –±–æ—Ç—É 35 –º–∏–Ω—É—Ç
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –í –ª–æ–≥–∞—Ö "[CLEANUP] –£–¥–∞–ª–µ–Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è"
journalctl -u mb-trust | grep CLEANUP
```

### 4. –¢–µ—Å—Ç health check:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ health check –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞
curl http://localhost:3000/api/health
journalctl -u mb-trust -n 20 | grep "ü§ñ"
# –û–∂–∏–¥–∞–µ—Ç—Å—è: "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
```

### 5. –¢–µ—Å—Ç –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:
```bash
# –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞
sudo pkill -9 -f "npm start"
# –ü–æ–¥–æ–∂–¥–∞—Ç—å 10 —Å–µ–∫—É–Ω–¥
sleep 10
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ systemd –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª —Å–µ—Ä–≤–∏—Å
systemctl status mb-trust
# –û–∂–∏–¥–∞–µ—Ç—Å—è: active (running)
```

---

## üöÄ –£–°–¢–ê–ù–û–í–ö–ê –ù–ê –°–ï–†–í–ï–†–ï

### –®–∞–≥ 1: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
scp src/lib/bot-launcher.ts root@109.69.58.185:/var/www/mb-trust/src/lib/
scp src/lib/telegram-init.ts root@109.69.58.185:/var/www/mb-trust/src/lib/
scp mb-trust-production.service root@109.69.58.185:/tmp/
```

### –®–∞–≥ 2: –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/mb-trust
npm run build
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å systemd unit

```bash
# –ó–∞–º–µ–Ω–∏—Ç—å unit file
sudo cp /tmp/mb-trust-production.service /etc/systemd/system/mb-trust.service

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo systemctl daemon-reload

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
sudo systemctl restart mb-trust

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
journalctl -u mb-trust -f
```

### –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:

```
Nov 11 XX:XX:XX mbimport.ru npx[XXXXX]:   ‚ñ≤ Next.js 13.5.11
Nov 11 XX:XX:XX mbimport.ru npx[XXXXX]:   - Local:        http://localhost:3000
Nov 11 XX:XX:XX mbimport.ru npx[XXXXX]:  ‚úì Ready in 973ms
Nov 11 XX:XX:XX mbimport.ru npx[XXXXX]: ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...
Nov 11 XX:XX:XX mbimport.ru npx[XXXXX]: ‚úÖ Telegram –±–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω
```

---

## üîß –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è:

```bash
# –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
systemctl status mb-trust

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
journalctl -u mb-trust -f

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤
journalctl -u mb-trust -n 100

# –¢–æ–ª—å–∫–æ –ª–æ–≥–∏ –±–æ—Ç–∞
journalctl -u mb-trust | grep -E "ü§ñ|BOT|SPAM|CLEANUP|AI"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞
curl http://localhost:3000/api/health
```

### –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞—â–∏—Ç—ã:

```bash
# –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª rate limit
journalctl -u mb-trust | grep "Rate limit –ø—Ä–µ–≤—ã—à–µ–Ω" | wc -l

# –°–∫–æ–ª—å–∫–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
journalctl -u mb-trust | grep "–ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" | wc -l

# –°–∫–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–π –±—ã–ª–æ –æ—á–∏—â–µ–Ω–æ
journalctl -u mb-trust | grep "CLEANUP" | wc -l

# –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ OpenAI retry —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª
journalctl -u mb-trust | grep "–ü–æ–ø—ã—Ç–∫–∞ 2/3" | wc -l
```

---

## üéØ –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
curl http://localhost:3000/api/health

# –ü–æ–ª–Ω—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç
sudo systemctl restart mb-trust && journalctl -u mb-trust -f

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
curl http://localhost:3000/api/health && sleep 2 && journalctl -u mb-trust -n 10 | grep "Telegram –±–æ—Ç"

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–ø–∞–º–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
journalctl -u mb-trust -f | grep -E "SPAM|CLEANUP"
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ü–û–°–õ–ï –£–°–¢–ê–ù–û–í–ö–ò

- [ ] –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
- [ ] –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
- [ ] Health check –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{"ok":true}`
- [ ] Rate limiting –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–ø–∞–º
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –º—É—Å–æ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- [ ] –°—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ –æ—á–∏—â–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- [ ] OpenAI –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è gracefully
- [ ] Systemd –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
- [ ] Health check –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–æ—Ç–∞

---

## üÜò –≠–ö–°–¢–†–ï–ù–ù–´–ï –ö–û–ú–ê–ù–î–´

### –ï—Å–ª–∏ –±–æ—Ç –∑–∞–≤–∏—Å:

```bash
curl http://localhost:3000/api/health
```

### –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ:

```bash
sudo systemctl restart mb-trust
```

### –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω —Å–ø–∞–º–æ–º:

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫—Ç–æ —Å–ø–∞–º–∏—Ç
journalctl -u mb-trust | grep "Rate limit –ø—Ä–µ–≤—ã—à–µ–Ω"

# –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
sudo systemctl stop mb-trust

# –ü–æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
sudo journalctl --vacuum-time=1d

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞
sudo systemctl start mb-trust
```

---

**üéâ –í–°–ï –ó–ê–©–ò–¢–´ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–´!**

